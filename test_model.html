<!DOCTYPE html>
<html>
<head>
    <title>YOLOv4 Model Test</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>
    <h1>YOLOv4 Model Test</h1>
    <div id="output"></div>
    
    <script>
        async function testModel() {
            const output = document.getElementById('output');
            
            try {
                output.innerHTML += '<p>Loading YOLOv4 model...</p>';
                
                // Configure ONNX Runtime
                ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/';
                
                // Load model
                const session = await ort.InferenceSession.create('/models/yolov4.onnx', {
                    executionProviders: ['wasm'],
                    graphOptimizationLevel: 'all'
                });
                
                output.innerHTML += '<p>✅ Model loaded successfully!</p>';
                
                // Check input details using correct API
                const inputNames = session.inputNames;
                const inputName = inputNames[0];
                output.innerHTML += `<p>Input name: ${inputName}</p>`;
                
                // Get input metadata
                if (session.inputMetadata && session.inputMetadata[inputName]) {
                    const inputMeta = session.inputMetadata[inputName];
                    output.innerHTML += `<p>Input shape: [${inputMeta.dimensions.join(', ')}]</p>`;
                    output.innerHTML += `<p>Input type: ${inputMeta.type}</p>`;
                } else {
                    output.innerHTML += '<p>Input metadata not available</p>';
                }
                
                // Check output details
                const outputNames = session.outputNames;
                output.innerHTML += `<p>Number of outputs: ${outputNames.length}</p>`;
                outputNames.forEach((name, i) => {
                    if (session.outputMetadata && session.outputMetadata[name]) {
                        const outMeta = session.outputMetadata[name];
                        output.innerHTML += `<p>Output ${i}: ${name} - [${outMeta.dimensions.join(', ')}]</p>`;
                    } else {
                        output.innerHTML += `<p>Output ${i}: ${name} - metadata not available</p>`;
                    }
                });
                
                // Test inference with dummy data (416x416x3 NHWC format)
                output.innerHTML += '<p>Testing inference with 416x416x3 NHWC...</p>';
                const inputData = new Float32Array(1 * 416 * 416 * 3).fill(0.5);
                const tensor = new ort.Tensor('float32', inputData, [1, 416, 416, 3]);
                const feeds = {};
                feeds[inputName] = tensor;
                
                const results = await session.run(feeds);
                output.innerHTML += '<p>✅ Inference test successful!</p>';
                
                Object.keys(results).forEach(key => {
                    output.innerHTML += `<p>Output ${key}: shape [${results[key].dims.join(', ')}]</p>`;
                });
                
            } catch (error) {
                output.innerHTML += `<p>❌ Error: ${error.message}</p>`;
                console.error(error);
            }
        }
        
        // Start test when page loads
        testModel();
    </script>
</body>
</html>
